<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="ZeroIdentidad"><meta name=description content="Gophers LATAM"><meta property="og:image" content="https://gophers-latam.github.io//logo.png"><title>Fuga de gorutinas – Gophers LATAM</title><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.d3a71c9a34f4c5a37a7d334d8c2961f8af1a22188792ebba80a2c80cef673488.css><link rel=stylesheet href=/css/syntax.min.f1fef9cbbfe9d2935981821d59853e89db60d137f9117a1279371320195f1d1a.css><link href='https://fonts.googleapis.com/css2?family=Work+Sans' rel=stylesheet type=text/css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-192145152-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7766642915413571" crossorigin=anonymous></script></head><body><div class=container><header class="page-header app-width"><div class=header-left><a href=/><img alt="Gophers LATAM" src=/img/gopher.png style=height:90px></a></div><div class=header-center><nav><a href=/>Inicio</a>
<a href=/biografia>Biografía</a>
<a href=/proyectos>Proyectos</a>
<a href=/posts>Posts</a>
<a href=/colaboradores>Colaboradores</a>
<a href=/contacto>Contacto</a></nav></div><div class=header-right><a class=button-search href=/search><img alt=Búsqueda src=/img/search.png></a></div></header><main class=app-width><article class=post><header><h2>Fuga de gorutinas</h2><span class=tags><a class=tag href=/tags/gorutinas>gorutinas</a>
<a class=tag href=/tags/aprendizaje>aprendizaje</a>
<a class=tag href=/tags/concurrencia>concurrencia</a></span>
<span class=meta><label>Por: <b>Andrés Reyes, el Programador Pobre</b></label>
<label>Publicado <b>December 20, 2023</b></label>
<label>Tiempo de lectura: <b>4 minutos</b>.</label></span></header><section class=body><figure class=post-figure><a href=/posts/2023/12/fuga-de-gorutinas/images/plumbing-pipe-wrench-plumber.jpg><img src=/posts/2023/12/fuga-de-gorutinas/images/plumbing-pipe-wrench-plumber_hu1e3512330b9ca3f140b030a292b63b13_88176_1024x0_resize_q75_box.jpg width=1024 height=683 alt="Fugas. imagen de dominio público gentileza pxfuel. https://www.pxfuel.com/en/free-photo-ojgpw"></a><figcaption>Fugas. imagen de dominio público gentileza pxfuel. https://www.pxfuel.com/en/free-photo-ojgpw</figcaption></figure><p>Sabemos que las gorutinas son una de las mas importantes primitivas que Go pone a nuestra disposición para el manejo de concurrencia. Por eso se hace necesaria una forma de prevenir <em>fugas de gorutinas</em>.</p><hr><h2 id=si-aun-no-empieza-a-estudiar-concurrencia-en-go-le-sugerimos-ver-estehttpsyoutubeplslyvhpyausiqvl-wjcv9nwzm2rm-video-de-la-comunidad-antes-de-leer-este-artículo>Si aun no empieza a estudiar concurrencia en Go ¡Le sugerimos ver <a href="https://youtu.be/plslYvhPyAU?si=qVl-wJcV9nWzM2Rm">este</a> video de la comunidad antes de leer este artículo!</h2><p>Una <em>fuga</em> o <em>leak</em> de gorutinas es cuando nuestra aplicación crea gorutinas sin tener el cuidado de terminarlas <em>correctamente</em>.</p><p>Observemos el siguiente ejemplo. Seguramente reconocerá el problema, en este caso estamos enviando información por un canal y no tenemos a nadie que consuma dicho canal.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;runtime&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>send</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>200</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>submit</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>send</span>() }()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>send</span>() }()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>send</span>() }()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>send</span>() }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>submitAll</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>5</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>submit</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>submitAll</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;número de gorutinas: %d\n&#34;</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>NumGoroutine</span>())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Si ejecutamos este programa veremos lo siguiente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go run  main.go 
</span></span><span style=display:flex><span>número de gorutinas: <span style=color:#ae81ff>16</span>
</span></span></code></pre></div><p>Imprime <code>número de gorutinas: 16</code> ¿Por que razón? Porque el contenido del loop se itera 4 veces y en cada iteración engendra 4 gorutinas en la función <code>submit</code>. Ingenuamente podriamos estar esperando que al salir del ámbito de la función submit las gorutinas se hubiesen cerrado ¡Pero no es así! ¡Siguen corriendo al final de su proceso como lo demuestra la impresión!</p><hr><h2 id=una-fuga-o-leak-de-gorutinas-es-cuando-nuestra-aplicación-crea-gorutinas-sin-tener-el-cuidado-de-terminarlas-correctamente>Una fuga o leak de gorutinas es cuando nuestra aplicación crea gorutinas sin tener el cuidado de terminarlas correctamente.</h2><p>Ahora bien, si nuestra aplicación terminara en este punto, no habría problema alguno, pues al acabar su ejecución ya es responsabilidad del sistema operativo realizar las labores de limpieza. Pero muchas veces usamos Go para construir aplicaciones que se ejecutan continuamente sin parar y que se espera que no se detengan, como servicios, apis, etc. En este tipo de aplicaciones, un escenario como el presentado en el ejemplo es insostenible.</p><p>Go reserva una cantidad de memoria específica <strong>inicial</strong> para que las gorutinas usen como su <a href=https://go.dev/doc/faq#stack_or_heap>stack</a>, si bien esta cantidad puede variar de versión en versión, la cantidad actual se puede revisar en el <a href=https://github.com/golang/go/blob/master/src/runtime/stack.go#L75>repositorio de GO</a></p><p><img src=images/stack_go.png alt=stack></p><p>Este stack puede ir creciendo según el proceso que se ejecute dentro de la gorutina.</p><h2 id=el-problema>El problema</h2><p>Entonces, ¿Que pasará si nuestra aplicación sufre de fuga de gorutinas y engendra 100000 de ellas durante un periódo de un año sin terminarlas correctamente?</p><p>Pues asumiendo optimistamente que el proceso que se ejecuta dentro de nuestras gorutinas fugadas devuelven correctamente la memoria, y que el stack asignado a cada una de ellas sigue teniendo un tamaño de 2kB, tendriamos para ese momento cerca de <strong>200MB</strong> de memoria usada por la aplicación que no podrán ser recuperados por el recolector de basura ¡Porque las gorutinas todavía están ejecutandose! ¡Porque nunca nos aseguramos de terminarlas correctamente!</p><hr><h2 id=si-no-cuidamos-de-terminar-correctamente-las-gorutinas-que-nuestra-aplicación-engendra-corremos-el-riesgo-de-enfrentar-out-of-memory-errors>Si no cuidamos de terminar correctamente las gorutinas que nuestra aplicación engendra, corremos el riesgo de enfrentar Out Of Memory Errors</h2><p>Si ejecutamos nuestra aplicación en algún tipo de contenedor o máquina virtual con un límite duro de memoría, esto puede llegar a ocasionar <a href=https://stackoverflow.com/questions/47447225/allocation-error-runtime-out-of-memory>out of memory errors</a></p><p>¿Que podemos hacer?</p><h2 id=previniendo-fugas-de-gorutinas>Previniendo fugas de gorutinas</h2><p>Inevitablemente debemos aprender y convertirnos en expertos en el <a href=https://go.dev/ref/mem>modelo de memoria de Go</a> y en su modelo de concurrencia. Esto es de vital importancia, pues de la misma forma que un carpintero es responsable de usar de forma segura su sierra circular, taladro y otros implementos, nosotros como programadores somos responsables de usar correctamente las herramientas de nuestro oficio.</p><p>En esto cae la construcción de tests y benchmarks y el uso profilactico de herramientas de perfilado como <a href=https://github.com/google/pprof>pprof</a> asegurandonos de que las pruebas se realicen por un periodo de tiempo conveniente, pues no es lo mismo perfilar un servicio el mismo día en que lo lanzamos a correr, que dos meses después.</p><p>Otra herramienta muy útil es <a href=https://github.com/uber-go/goleak>goleak</a> del equipo de <a href=https://github.com/uber-go>Uber Go</a>, que presenta una forma muy simple de testear que nuestras gorutinas se cierren correctamente.</p><p>Se usa de la siguiente forma:</p><p>1 Debemos importarla a nuestro proyecto <code>$ go get -u go.uber.org/goleak</code></p><p>2 Debemos construir un test que incluya el flujo completo de nuestras gorutinas. Usaremos el mismo ejemplo anterior</p><p>Importamos la utilidad y nos aseguramos de invocarla usando defer para que se garantice su ejecución al final de nuestro proceso.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.uber.org/goleak&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestGorutineLeak</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>VerifyNone</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>4</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>submitAll</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>¡Y listo! Al ejecutar el test, si goleak detecta fugas de gorutinas, el test fallará</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go test ./...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>===</span> RUN   TestGorutineLeak
</span></span><span style=display:flex><span>    /home/jacobopus/projects/go/goru/main_test.go:15: found unexpected goroutines:
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>Goroutine <span style=color:#ae81ff>7</span> in state chan send, with goru.submit.func1 on top of the stack:
</span></span><span style=display:flex><span>        goru.submit.func1<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        	/home/jacobopus/projects/go/goru/main.go:19 +0x30
</span></span><span style=display:flex><span>        created by goru.submit in goroutine <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>        	/home/jacobopus/projects/go/goru/main.go:19 +0x66
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>--- FAIL: TestGorutineLeak <span style=color:#f92672>(</span>4.46s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>FAIL
</span></span></code></pre></div><p>Puede revisar la <a href=https://github.com/uber-go/goleak/blob/master/README.md>documentación</a> de goleak para descubrir otras formas de uso.</p><p>No olvide compartir este articulo si fue de su agrado.</p></section><section class=related><h3>Relacionados</h3><div class=post-list><article class="box box-post"><a class=title href=/posts/2023/10/el-tour-de-go-ahora-en-espa%C3%B1ol/><h3>El tour de Go ahora en Español</h3></a><time class=date>October
27
2023</time><div class=summary-container><figure class=post-figure><a href=/posts/2023/10/el-tour-de-go-ahora-en-espa%C3%B1ol/images/tour3.png><img src=/posts/2023/10/el-tour-de-go-ahora-en-espa%C3%B1ol/images/tour3_hu513b247d847e7fe7c11df40df90a15e1_538565_1024x0_resize_box_3.png width=1024 height=1039 alt="Tour de Go en Español"></a><figcaption>Tour de Go en Español</figcaption></figure><p>¡Logramos algo increíble como comunidad!
La traducción del tour de Go al español.
Estamos emocionados de compartir con todos ustedes el increíble logro que hemos alcanzado juntos: la completa traducción del tour de Go al español.</p><p>Este proyecto fue un esfuerzo colaborativo en el que nuestra comunidad contribuyó con su tiempo y conocimiento para hacer que esta herramienta esté disponible para toda la comunidad hispanohablante. ¡El resultado es asombroso!</p></div></article></div></section><section class=comments><h3>Comentar</h3><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//gophers-latam.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></main><footer><a href=https://gohugo.io><img src=/img/hugo-logo.svg width=90 height=21></a>
<small>© 2023, Gophers LATAM. - Theme by <a href=https://github.com/zeroidentidad>zeroidentidad</a>.</small></footer></div></body></html>