<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="ZeroIdentidad"><meta name=description content="Gophers LATAM"><meta property="og:image" content="https://gophers-latam.github.io//logo.png"><title>Concatenando strings. Construyendo SQL – Gophers LATAM</title><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.3729e22ad9cf9ffeda18780775c1ae6e14a679d8eee47c70eb24a09bfd2e54b7.css><link rel=stylesheet href=/css/syntax.min.f1fef9cbbfe9d2935981821d59853e89db60d137f9117a1279371320195f1d1a.css><link href='https://fonts.googleapis.com/css2?family=Work+Sans' rel=stylesheet type=text/css></head><body><div class=container><header class="page-header app-width"><div class=header-left><a href=/><img alt="Gophers LATAM" src=/img/gopher.png style=height:90px></a></div><div class=header-center><div class=menu-button><span><img alt="mobile menu" src=/img/menu.svg alt></span></div><nav class="nav-links hide-on-mobile"><a href=/>Inicio</a>
<a href=/biografia>Biografía</a>
<a href=/proyectos>Proyectos</a>
<a href=/posts>Posts</a>
<a href=/colaboradores>Colaboradores</a>
<a href=/contacto>Contacto</a></nav><script src=https://gophers-latam.github.io/js/header-mobile.js defer></script></div><div class=header-right><a class=button-search href=/search><img alt=Búsqueda src=/img/search.png></a></div></header><main class=app-width><article class=post><header><h2>Concatenando strings. Construyendo SQL</h2><span class=tags><a class=tag href=/tags/golang>golang</a>
<a class=tag href=/tags/sql>sql</a>
<a class=tag href=/tags/strings>strings</a></span>
<span class=meta><label>Por: <b>Andrés Reyes. El Programador Pobre</b></label>
<label>Publicado <b>January 21, 2024</b></label>
<label>Tiempo de lectura: <b>13 minutos</b>.</label></span></header><section class=body><figure class=post-figure><a href=/posts/2024/01/concatenando-strings.-construyendo-sql/images/builders.png><img src=/posts/2024/01/concatenando-strings.-construyendo-sql/images/builders_hu484691413f27fc3340745a7b2cb74546_371474_1024x0_resize_box_3.png width=1024 height=693 alt="json to go"></a><figcaption>json to go</figcaption></figure><p>Los strings son un tipo de dato peculiar. A simple vista parecieran no esconder nada raro, pero si los comparamos con tipos de dato numéricos encontramos diferencias interesantes.</p><p>Un string compuesto de solo un caracter, por ejemplo <em>&ldquo;A&rdquo;</em>, ocupa un byte completo para almacenarse. En un byte el número entero sin signo mas pequeño que podemos guardar es 0, siendo 255 el mas grande posible de almacenarse. O sea, <strong>un solo caracter</strong> como <em>&ldquo;A&rdquo;</em> ocupa la misma cantidad de memoria que un valor del tipo <code>uint8</code>.</p><p>Entonces ¿Cuanta memoria podemos usar al concatenar una enorme cantidad de caracteres en strings de gran tamaño? Investiguémoslo con uno de los usos mas frecuentes de construcción dinámica de strings; la creación de consultas SQL.</p><p>Terminaremos además con una bonita técnica para disminuir aun mas los direccionamientos al guardar los parámetros para la consulta SQL en un slice.</p><hr><h2 id=nosotros-no-le-creemos-nada-a-nadie-todo-lo-comprobamos-por-nosotros-mismos-por-eso-acompañamos-cada-ejemplo-con-su-respectivo-benchmark-ud-debería-hacer-lo-mismo-ya-que-proveemos-los-benchmarks-para-este-experimento>Nosotros no le creemos nada a nadie, todo lo comprobamos por nosotros mismos. Por eso acompañamos cada ejemplo con su respectivo benchmark. ¡Ud. debería hacer lo mismo ya que proveemos los benchmarks para este experimento!</h2><p>Construiremos una consulta sql de varias formas distintas y mediremos su eficiencia con benchmarks.</p><p>Usaremos el siguiente struct para proveer los datos para construir el filtro:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Filter</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ID</span>       <span style=color:#66d9ef>int64</span>   <span style=color:#75715e>// provee el id a buscar
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Name</span>     <span style=color:#66d9ef>string</span>  <span style=color:#75715e>// provee el nombre a buscar
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Lastname</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Search</span>   <span style=color:#66d9ef>string</span>  <span style=color:#75715e>// provee un valor por cual buscar usando LIKE a nombres o apellidos
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Limit</span>    <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Offset</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Usaremos la siguiente constante como base para la consulta que construiremos:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>qb</span> = <span style=color:#e6db74>`SELECT id, name, last_name FROM clientes WHERE 1=1 %ATTRS% %ID%  %FIRST_NAME% %LAST_NAME%  %LIMIT% %OFFSET%`</span>
</span></span></code></pre></div><p>Y la función que construye la consulta con dicho filtro, la cual se basa en la técnica de colocar patrones en el texto y reemplazarlos al ir construyendo la consulta concatenando strings sucesivos:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>QueryBuilderEvil</span>(<span style=color:#a6e22e>f</span> <span style=color:#a6e22e>Filter</span>) (<span style=color:#66d9ef>string</span>, []<span style=color:#a6e22e>any</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sql</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qb</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>params</span> []<span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%ATTRS%&#34;</span>, <span style=color:#e6db74>&#34; AND ( name LIKE ? OR last_name LIKE ?)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#e6db74>&#34;%&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;%&#34;</span>, <span style=color:#e6db74>&#34;%&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;%&#34;</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%ATTRS%&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ID</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%ID%&#34;</span>, <span style=color:#e6db74>&#34; AND id = ?&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ID</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%ID%&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%FIRST_NAME%&#34;</span>, <span style=color:#e6db74>&#34; AND name = ?&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%FIRST_NAME%&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Lastname</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%LAST_NAME%&#34;</span>, <span style=color:#e6db74>&#34; AND last_name = ?&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Lastname</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%LAST_NAME%&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Limit</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%LIMIT%&#34;</span>, <span style=color:#e6db74>&#34; LIMIT ?&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Limit</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%LIMIT%&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Offset</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%OFFSET%&#34;</span>, <span style=color:#e6db74>&#34; OFFSET ?&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Offset</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sql</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#a6e22e>sql</span>, <span style=color:#e6db74>&#34;%OFFSET%&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sql</span>, <span style=color:#a6e22e>params</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Antes de analizar, veamos el resultado del benchmark de esta función. En mi máquina arroja estos resultados:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkEvil</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Filter</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>:     <span style=color:#e6db74>&#34;a&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Lastname</span>: <span style=color:#e6db74>&#34;b&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Search</span>:   <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Limit</span>:    <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>ResetTimer</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>QueryBuilderEvil</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>BenchmarkEvil-16    	 1655064	       705.8 ns/op	     <span style=color:#ae81ff>720</span> B/op	      <span style=color:#ae81ff>11</span> allocs/op
</span></span></code></pre></div><p>El benchmark nos dice que se ejecutó la función 18720764 veces, durando 764 ns cada iteración, direccionado 784 bytes cada iteración, realizando 11 localizaciones al heap.</p><p>¿Parece rápido? ¿Que puede tener esto de malo? Observe los bytes direccionados, 784. Esto, mas o menos significa que se guardaron en memoria el equivalente a 784 letras &ldquo;A&rdquo;.</p><p>Reunamos mas información. Usemos el flag <code>-gcflags="-m"</code> para descubrir donde se producen los direccionamientos en el heap.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./main_test.go:21:15: q escapes to heap
</span></span><span style=display:flex><span>./main.go:89:39: <span style=color:#e6db74>&#34;%&#34;</span> + f.Search + <span style=color:#e6db74>&#34;%&#34;</span> escapes to heap
</span></span><span style=display:flex><span>./main.go:89:39: <span style=color:#e6db74>&#34;%&#34;</span> + f.Search + <span style=color:#e6db74>&#34;%&#34;</span> escapes to heap
</span></span><span style=display:flex><span>./main.go:89:57: <span style=color:#e6db74>&#34;%&#34;</span> + f.Search + <span style=color:#e6db74>&#34;%&#34;</span> escapes to heap
</span></span><span style=display:flex><span>./main.go:89:57: <span style=color:#e6db74>&#34;%&#34;</span> + f.Search + <span style=color:#e6db74>&#34;%&#34;</span> escapes to heap
</span></span></code></pre></div><p>¡Observe además que cada concatenación con + escapa al heap! Cada una genera un direccionamiento nuevo, Lo que si leyó un <a href=https://gophers-latam.github.io/posts/2023/12/manejo-de-memoria-101.-memoria-virtual-stack-y-heap/>artículo anterior</a>, entenderá que puede ser susceptible de mejorar.</p><p>Pero ¿Que alternativas hay?</p><h2 id=construyendo-strings-de-forma-eficiente-con-stringsbuilder>Construyendo strings de forma eficiente con <code>strings.Builder</code></h2><p>Tratemos de mejorar nuestra implementación. Usando el mismo struct para el filtro, cambiemos la constante base de sql.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>q</span> = <span style=color:#e6db74>`SELECT id, name, last_name FROM clientes WHERE 1=1`</span>
</span></span></code></pre></div><p>Y revisemos esta función alternativa para construir la consulta:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>{}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// le indicamos una capacidad al slice que contendrá los parámetros de la query
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// iguala la cantidad máxima de elementos posibles de agregar al filtro
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>any</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>7</span>) 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>q</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ID</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND id = ?&#34;</span>) <span style=color:#75715e>// Agregamos el segmento del filtro sql y el parámetro posicional
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ID</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>//             Nótese el espacio extra antes del sql
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND name = ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Lastname</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND last_name = ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Lastname</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND ( name LIKE ? OR last_name LIKE ?)&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%%%s%%&#34;</span>,<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span>), <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%%%s%%&#34;</span>,<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Limit</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; LIMIT ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Limit</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Offset</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; OFFSET ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Offset</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>params</span>
</span></span></code></pre></div><p>Revisemos el resultado del benchmark:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkOK</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Filter</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>:     <span style=color:#e6db74>&#34;a&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Lastname</span>: <span style=color:#e6db74>&#34;b&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Search</span>:   <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Limit</span>:    <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>ResetTimer</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>QueryBuilderOK</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>BenchmarkOK-16    	 6253722	       234.3 ns/op	     <span style=color:#ae81ff>336</span> B/op	       <span style=color:#ae81ff>5</span> allocs/op
</span></span></code></pre></div><p>¡Vaya! hemos pasado de 705.8 ns a 234.3 ns, y de un consumo de memoria de 720 bytes disminuimos a 336 bytes ¡Bastante bien no!</p><hr><h2 id=gracias-al-uso-eficiente-de-stringsbuilder-podemos-evitar-concatenaciones-costosas>Gracias al uso eficiente de strings.Builder podemos evitar concatenaciones costosas.</h2><p>Estas mejoras se explican porque este nuevo constructor de la consulta delega el manejo de la construcción del string a <a href=https://pkg.go.dev/strings#Builder><code>strings.Builder</code></a>, cuya documentación nos explica que es un tipo de dato que permite construir strings minimizando las copias de memoria que como Ud. ya está imaginando es donde se produce la demora en ejecución y el costo.</p><p>Gracias al uso eficiente de <code>strings.Builder</code> podemos dejar de usar la técnica de búsqueda y reemplazo en el string que estamos construyendo y podemos evitar concatenaciones costosas.</p><h2 id=llevando-esto-al-extremo>Llevando esto al extremo</h2><p>¿Hasta que punto deberíamos llegar al pensar en evitar concatenaciones y reemplazarlas por <code>strings.Builder</code>?</p><p>Depende de lo que estemos tratando de hacer. Por ejemplo, en nuestra función <code>QueryBuilderOK</code> Ud. podría decir que en donde se construyen los likes se esta usando <code>fmt.Sprintf</code>, y si acaso no sería mejor usar un builder.</p><p>¡Comprobemoslo! Construyamos una tercera función para generar nuestra consulta sql.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>QueryBuilderOKAlter</span>(<span style=color:#a6e22e>f</span> <span style=color:#a6e22e>Filter</span>) (<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>, []<span style=color:#a6e22e>any</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>any</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>7</span>) <span style=color:#75715e>// 7 es la cantidad máxima de elementos que se pueden agregar al filtro
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>q</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ID</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND id = ?&#34;</span>) <span style=color:#75715e>// Agregamos el segmento del filtro sql y el parámetro posicional
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ID</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>//             Nótese el espacio extra antes del sql
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND name = ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Lastname</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND last_name = ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Lastname</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND ( name LIKE ? OR last_name LIKE ?)&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>{}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b2</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;%&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b2</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b2</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;%&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>b2</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b2</span>.<span style=color:#a6e22e>Reset</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b2</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;%&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b2</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b2</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;%&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>b2</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Limit</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; LIMIT ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Limit</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Offset</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; OFFSET ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>params</span> = append(<span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Offset</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>params</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Con su benchmark respectivo</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkOKAlter</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Filter</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>:     <span style=color:#e6db74>&#34;a&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Lastname</span>: <span style=color:#e6db74>&#34;b&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Search</span>:   <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Limit</span>:    <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>ResetTimer</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>QueryBuilderOKAlter</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Y ejecutemos varias veces los benchmarks para considerar pequeñas variaciones.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Usamos el flag -count para indicar el número de ejecuciones </span>
</span></span><span style=display:flex><span><span style=color:#75715e># de nuestros benchmarks</span>
</span></span><span style=display:flex><span><span style=color:#75715e># y el flag -benchtime para indicar el tiempo mínimo que debería durar cada bench</span>
</span></span><span style=display:flex><span>go test -benchmem -count<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span> -benchtime<span style=color:#f92672>=</span>2s -bench . 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>goos: linux
</span></span><span style=display:flex><span>goarch: amd64
</span></span><span style=display:flex><span>pkg: aa
</span></span><span style=display:flex><span>cpu: Intel<span style=color:#f92672>(</span>R<span style=color:#f92672>)</span> Core<span style=color:#f92672>(</span>TM<span style=color:#f92672>)</span> i7-10700 CPU @ 2.90GHz
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3066897</span>               744.7 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3498865</span>               727.4 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3386638</span>               718.1 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3180061</span>               728.8 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3392404</span>               741.4 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3488655</span>               732.3 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3306530</span>               736.1 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3028632</span>               718.3 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3517440</span>               710.5 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3404026</span>               704.9 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3467962</span>               756.4 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3440934</span>               738.0 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3392062</span>               711.4 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3522846</span>               735.8 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3203848</span>               701.6 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkEvil-16         <span style=color:#ae81ff>3502076</span>               732.7 ns/op           <span style=color:#ae81ff>720</span> B/op         <span style=color:#ae81ff>11</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>11799339</span>               228.8 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>11871458</span>               228.2 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>11488488</span>               264.0 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>12074823</span>               236.2 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16           <span style=color:#ae81ff>9447732</span>               229.9 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>10044681</span>               204.5 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>12510486</span>               232.0 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>10445984</span>               256.5 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>11243646</span>               250.3 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>11259970</span>               251.3 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16           <span style=color:#ae81ff>9696850</span>               247.5 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>11768199</span>               285.7 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>10200710</span>               235.4 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16           <span style=color:#ae81ff>9136749</span>               232.4 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16           <span style=color:#ae81ff>9717814</span>               242.0 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOK-16          <span style=color:#ae81ff>10739455</span>               240.3 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16     <span style=color:#ae81ff>10271550</span>               246.1 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>8569068</span>               237.5 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>8484096</span>               277.7 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>8993108</span>               265.8 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>8013882</span>               286.9 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>8815909</span>               240.2 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>9611652</span>               261.0 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>8601260</span>               234.4 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>9384111</span>               256.7 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>7744686</span>               268.7 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>8082067</span>               289.4 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16     <span style=color:#ae81ff>11854416</span>               213.5 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16     <span style=color:#ae81ff>10229622</span>               286.3 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16     <span style=color:#ae81ff>10405981</span>               219.1 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16      <span style=color:#ae81ff>8921347</span>               242.1 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKAlter-16     <span style=color:#ae81ff>11861126</span>               261.1 ns/op           <span style=color:#ae81ff>336</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      aa      144.342s
</span></span></code></pre></div><p>Si tomamos los resultados y los ordenamos desde el más rápido hasta el mas lento, vemos que no hay una gran diferencia entre las funciones OK, y que incluso <code>QueryBuilderOK</code> es un poco mas veloz que <code>QueryBuilderOKAlter</code>.</p><p>En el apartado de memoria ambas gastaron la misma cantidad y realizaron el mismo número de direccionamientos.</p><p><img src=images/bench-chart.png alt="Alt text"></p><p>¿Esto significa que cuando necesitemos hacer pocas concatenaciones, o cuando lo tengamos que hacer sobre strings muy pequeños no deberíamos usar <code>strings.Builder</code>?</p><p>¡No lo se! Dependerá de que tan <em>pocas concatenaciones</em> y que <em>tan pequeños</em> sean los strings de su caso. Lo único que puedo recomendarle es construir su programa de forma tal que pueda realizar los benchmarks correspondientes y tomar la decisión con base a los números presentados por estos en cada situación.</p><h2 id=aplicando-la-técnica-de-máscaras-de-parámetros>Aplicando la técnica de máscaras de parámetros</h2><p>Ahora bien, En el caso de nuestro ejemplo hay formas de optimizar aun mas a nuestro builder que ya no pasan directamente por el manejo del string. Podemos usar la técnica de usar una <strong>máscara</strong> para determinar el tamaño exacto de los parámetros a agregar a la consulta y direccionar previamente la memoria con ese número para evitar realizar <code>appends</code> mientras se va construyendo la consulta, de la misma forma que evitamos concatenar gracias a <code>strings.Builder</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>QueryBuilderOKMask</span>(<span style=color:#a6e22e>f</span> <span style=color:#a6e22e>Filter</span>) (<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>, []<span style=color:#a6e22e>any</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// tenemos una instancia de un struct con un campo booleano para
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// cada elemento del filtro
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mask</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ID</span>       <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>     <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Lastname</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Search</span>   <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Limit</span>    <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Offset</span>   <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	}{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>q</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Usaremos a size para indicar cuantos elementos tendrá finalmente el slice de parámetros de la consulta
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>size</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ID</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND id = ?&#34;</span>) <span style=color:#75715e>// Agregamos el segmento del filtro sql y el parámetro posicional
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Si el elemento del filtro se agrega, se establece su máscara a verdadero
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>ID</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// y se aumenta en 1 el tamaño esperado para el slice de parámetros
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>size</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND name = ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>size</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Lastname</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND last_name = ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>Lastname</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>size</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; AND ( name LIKE ? OR last_name LIKE ?)&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>Search</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>size</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Limit</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; LIMIT ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>Limit</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>size</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Offset</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34; OFFSET ?&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>Offset</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>size</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// direccionamos el slice de parámetros con la memoria exacta que necesitamos
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>any</span>, <span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// y solo agregamos al slice los elementos del filtro que tengan su respectiva máscara activada
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>ID</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ID</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>Name</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>Lastname</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Lastname</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>Search</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%%%s%%&#34;</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%%%s%%&#34;</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Search</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>Limit</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Limit</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mask</span>.<span style=color:#a6e22e>Offset</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Offset</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>p</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>El respectivo benchmark</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkOKMask</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Filter</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>:     <span style=color:#e6db74>&#34;a&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Lastname</span>: <span style=color:#e6db74>&#34;b&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Search</span>:   <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Limit</span>:    <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>ResetTimer</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>QueryBuilderOKMask</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>El cual al ejecutarse nos arroja los siguientes resultados.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>10261683</span>               213.8 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>12145034</span>               230.7 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16       <span style=color:#ae81ff>9883455</span>               213.3 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>10661880</span>               212.3 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>12725306</span>               211.5 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16       <span style=color:#ae81ff>9966832</span>               225.5 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16       <span style=color:#ae81ff>9271009</span>               216.3 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16       <span style=color:#ae81ff>8934564</span>               236.4 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>12176293</span>               249.7 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>11495956</span>               236.9 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>10586841</span>               224.2 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>12398922</span>               213.3 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16       <span style=color:#ae81ff>9481837</span>               247.0 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>10852344</span>               226.4 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>12089485</span>               216.7 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span><span style=display:flex><span>BenchmarkOKMask-16      <span style=color:#ae81ff>10944657</span>               201.9 ns/op           <span style=color:#ae81ff>272</span> B/op          <span style=color:#ae81ff>5</span> allocs/op
</span></span></code></pre></div><p>!Vemos una mejora en el consumo de memoria y en la velocidad de ejecución!</p><p>Concluyendo, no le crea a nada ni a nadie, compruebelo todo con benchmarks por si mismo en un ambiente lo mas parecido a sus máquinas de producción si le es posible. Detecte los cuellos de botella en su programa y aplique las medidas que su experiencia y conocimiento provean.</p><p>Dejamos a su disposición el código provisto en este artículo en <a href=https://github.com/profe-ajedrez/building_string_ex>este</a> repositorio.</p><p>Y con esto despedimos este artículo, no olvide comentar si precisa hacer algún alcance y compartirlo si es que le gustó.</p></section><section class=related><h3>Relacionados</h3><div class=post-list><article class="box box-post"><a class=title href=/posts/2023/10/el-tour-de-go-ahora-en-espa%C3%B1ol/><h3>El tour de Go ahora en Español</h3></a><time class=date>October
27
2023</time><div class=summary-container><figure class=post-figure><a href=/posts/2023/10/el-tour-de-go-ahora-en-espa%C3%B1ol/images/tour3.png><img src=/posts/2023/10/el-tour-de-go-ahora-en-espa%C3%B1ol/images/tour3_hu513b247d847e7fe7c11df40df90a15e1_538565_1024x0_resize_box_3.png width=1024 height=1039 alt="Tour de Go en Español"></a><figcaption>Tour de Go en Español</figcaption></figure><p>¡Logramos algo increíble como comunidad!
La traducción del tour de Go al español.
Estamos emocionados de compartir con todos ustedes el increíble logro que hemos alcanzado juntos: la completa traducción del tour de Go al español.</p><p>Este proyecto fue un esfuerzo colaborativo en el que nuestra comunidad contribuyó con su tiempo y conocimiento para hacer que esta herramienta esté disponible para toda la comunidad hispanohablante. ¡El resultado es asombroso!</p></div></article><article class="box box-post"><a class=title href=/posts/2024/01/desarrollo-con-go-en-neovim/><h3>Desarrollo con Go en Neovim</h3></a><time class=date>January
3
2024</time><div class=summary-container><figure class=post-figure><a href=/posts/2024/01/desarrollo-con-go-en-neovim/images/nvim-go.png><img src=/posts/2024/01/desarrollo-con-go-en-neovim/images/nvim-go_hu5d8b93b2e980550baa9318235e855019_465465_1024x0_resize_box_3.png width=1024 height=683 alt="Go con Neovim"></a><figcaption>Go con Neovim</figcaption></figure><p>En este post vamos a ver cómo configurar desde cero Neovim y específicamente cómo personalizarlo para que nuestro desarrollo con Go sea altamente productivo.</p></div></article><article class="box box-post"><a class=title href=/posts/2023/03/handlers-con-timeout/><h3>Handlers Con Timeout</h3></a><time class=date>March
27
2023</time><div class=summary-container><figure class=post-figure><a href=/posts/2023/03/handlers-con-timeout/images/go-handlers.jpeg><img src=/posts/2023/03/handlers-con-timeout/images/go-handlers_hu161c36eb0798f353d6185a69d9318760_46456_1024x0_resize_q75_box.jpeg width=1024 height=568 alt="go handlers"></a><figcaption>go handlers</figcaption></figure><p>En algunas oportunidades, vamos a necesitar un comportamiento <strong>muy</strong> determinístico en nuestras APIs, ya sea porque el negocio así lo requiere o los clientes. Tal vez, un comportamiento que se mantenga alejado de cualquier sorpresa, puede ser el máximo de duración que le queremos dejar como ventana para que un respuesta sea entregada, en caso de excederlo, ahora si como el título lo dice, devolvemos un <strong>timeout</strong>&mldr; pero, qué es un timeout?</p></div></article><article class="box box-post"><a class=title href=/posts/2022/08/intro-go-mistakes-okno/><h3>Intro Go Mistakes Okno</h3></a><time class=date>August
1
2022</time><div class=summary-container><figure class=post-figure><a href=/posts/2022/08/intro-go-mistakes-okno/images/ok-no.png><img src=/posts/2022/08/intro-go-mistakes-okno/images/ok-no_hu67b008a377f65ecd767073b64a23de40_12277_1024x0_resize_box_3.png width=1024 height=443 alt=okno></a><figcaption>okno</figcaption></figure><p>Se comparte el concepto o contexto de algunos errores basicos con su definición acompañado de ejemplo y solución.</p></div></article><article class="box box-post"><a class=title href=/posts/2021/12/ecosistema-lenguage-go/><h3>Ecosistema lenguage Go</h3></a><time class=date>December
27
2021</time><div class=summary-container><figure class=post-figure><a href=/posts/2021/12/ecosistema-lenguage-go/images/golang.png><img src=/posts/2021/12/ecosistema-lenguage-go/images/golang_hu57fed90b28f13fac04b0b2a1fb7dff6d_26167_1024x0_resize_box_3.png width=1024 height=346 alt="json to go"></a><figcaption>json to go</figcaption></figure><p>Go, también conocido como Golang, es un lenguaje de programación de tipado estático desarrollado por Robert Griesemer, Rob Pike y Ken Thompson en Google.</p></div></article></div></section><section class=comments><h3>Comentar</h3><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//gophers-latam.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></main><footer><a href=https://gohugo.io><img src=/img/hugo-logo.svg width=90 height=21></a>
<small>© 2024, Gophers LATAM. - Theme by <a href=https://github.com/zeroidentidad>zeroidentidad</a>.</small></footer></div></body></html>